#include "Game.hpp"
#include "TextureManager.hpp"
#include "Map.hpp"
#include "ECSystem/Components.hpp"
#include "Vector2D.hpp"
#include "Collision.hpp"

Map* arenaMap;
Manager manager;

SDL_Renderer* Game::renderer = nullptr;
SDL_Event Game::event;

std::vector< ColliderComponent* > Game::colliders;

auto& player( manager.addEntity() );
auto& wall( manager.addEntity() );

enum groupLabels : std::size_t {
    groupMap,
    groupPlayer,
    groupEnemies,
    groupObjects,
    groupColliders
};

Game::Game()
{}

Game::~Game()
{}

void Game::init( const char* title, int windowWidth, int windowHeight, bool fullscreen )
{
    int flags = 0;
    if ( fullscreen )
	flags = SDL_WINDOW_FULLSCREEN;



    if ( SDL_Init( SDL_INIT_EVERYTHING ) == 0 )
    {
	printf( "SDL initialized successfully!\n" );
	window = SDL_CreateWindow( title, SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED, windowWidth, windowHeight, flags );

	if ( window )
	    printf( "Window successfully created!\n" );

	renderer = SDL_CreateRenderer( window, -1, 0 );
	if ( renderer )
	{
	    printf( "Renderer initialized successfully!\n" );
	    SDL_SetRenderDrawColor( renderer, 200, 200, 200, 255 );
	}

	isActive = true;
    }
    else
	isActive = false;


    arenaMap = new Map();

    Map::loadMap( "Assets/arena.map", 16, 16);

    player.addComponent< TransformComponent >( 2 );
    player.addComponent< SpriteComponent >( "Assets/SpriteSheet.png", 7, 500 );
    player.addComponent< KeyboardConstroller >( );
    player.addComponent< ColliderComponent >( "player" );
    player.addGroup( groupPlayer );

    wall.addComponent< TransformComponent >( 300.0f, 300.0f, 300, 20, 1 );
    wall.addComponent< SpriteComponent >( "Assets/ground.png" );
    wall.addComponent< ColliderComponent >( "wall" );
    wall.addGroup( groupMap );
}

void Game::handleEvents()
{

    SDL_PollEvent( &event );
    switch ( event.type)
    {
	case SDL_QUIT:
	    isActive = false;
	    break;

	default:
	    break;
    }
}

void Game::update()
{
    manager.refresh();
    manager.update();

    for( auto& coll : colliders )
    {
	Collision::AABB( player.getComponent< ColliderComponent >(), *coll );
    }
}

auto& tiles( manager.getGroup( groupMap ) );
auto& players( manager.getGroup( groupPlayer ) );
auto& enemies( manager.getGroup( groupEnemies ) );

void Game::render()
{
    SDL_RenderClear( renderer );

    for ( auto& tile : tiles ) { tile->draw(); }
    for ( auto& plyr : players ) { plyr->draw(); }
    for ( auto& enem : enemies ) { enem->draw(); }

    SDL_RenderPresent( renderer );
}

void Game::clean()
{
    SDL_DestroyWindow( window );
    SDL_DestroyRenderer( renderer );
    SDL_Quit();

    printf( "SDL cleaned!\n" );
}

bool Game::isRunning() { return this->isActive; }

void Game::addTile( int id, int x, int y )
{
    auto& tile( manager.addEntity() );
    tile.addComponent< TileComponent > ( x, y, 32, 32, id );
    tile.addGroup( groupMap );
}
